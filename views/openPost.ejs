<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Open Post</title>
  <link rel="stylesheet" href="/css/openPost.css">
</head>
<body>

  <header>
    <a href="/feed" style="text-decoration: none;">
      <h2 class="logo" style="color: white; margin: 0;">TextNest</h2>
    </a>
    <nav class="navigation">
      <a href="/create" role="button">Create Post</a>
      <a href="/manageTags" role="button">Manage Tags</a>
      <a href="/profile" role="button">User Profile</a>
      <button onclick="window.location.href='/logout'" class="btn-LoginPopup logout-btn">Logout</button>
    </nav>
  </header>

  <div class="main-container">
    <!-- Post Details Section -->
    <div class="post-details">
      <h1><%= post.title %></h1>
      <p>Description: <%= post.description %></p>
      <p>Author: <%= post.author.username %></p>
      <p>Posted on: <%= post.time %></p>
      <p>Tags:
        <% for (let j=0; j < post.tags.length; j++) { %>
          <a href="/viewTagPosts/<%= post.tags[j]._id %>"><%= post.tags[j].name %></a>
          <% if (j !== post.tags.length - 1) { %>, <% } %>
        <% } %>
      </p>
      <p>Votes: <span id="voteCount_<%= post._id %>"><%= post.votes %></span></p>
      
      <div class="vote-buttons">
        <button id="upvoteButton_<%= post._id %>" class="<%= checkUp == 1 ? 'upvoted' : '' %>" onclick="upvotePost('<%= post._id %>')">Upvote</button>
        <button id="downvoteButton_<%= post._id %>" class="<%= checkDown == 1 ? 'downvoted' : '' %>" onclick="downvotePost('<%= post._id %>')">Downvote</button>
      </div>
    </div>

    <!-- Comments Section -->
    <div class="comments-section">
      <h3>Comments</h3>
      <ul class="comments-list">
        <% post.comments.forEach(function(comment) { %>
          <li class="comment-item">
            <p><%= comment.content %></p>
            <p>Author: <%= comment.author.username %> | Posted on: <%= comment.time %></p>
            <p>Votes: <span id="voteCount_<%= comment._id %>"><%= comment.votes %></span></p>
            
            <div class="vote-buttons">
              <button id="upvoteButton_<%= comment._id %>" class="<%= comment.upvotes.includes(user._id) ? 'upvoted' : '' %>" onclick="upvoteComment('<%= comment._id %>')">Upvote</button>
              <button id="downvoteButton_<%= comment._id %>" class="<%= comment.downvotes.includes(user._id) ? 'downvoted' : '' %>" onclick="downvoteComment('<%= comment._id %>')">Downvote</button>
            </div>

            <!-- Replies Section -->
            <button class="viewRepliesButton" onclick="toggleReplies('<%= comment._id %>')">View Replies</button>
            <div id="replies_<%= comment._id %>" class="replies" style="display: none;">
              <% if (comment.replies && comment.replies.length > 0) { %>
                <% comment.replies.forEach(reply => { %>
                  <div class="reply" data-reply-id="<%= reply._id %>">
                    <p><%= reply.author.username %>: <%= reply.content %></p>
                  </div>
                <% }) %>
              <% } %>
              <form class="replyForm" action="/comments/<%= comment._id %>/reply" method="POST">
                <textarea name="replyContent" required placeholder="Write your reply here"></textarea>
                <button type="submit">Submit Reply</button>
              </form>
            </div>
          </li>
        <% }) %>
      </ul>

      <!-- Comment Form -->
      <h4>Add a Comment</h4>
      <form id="comment-form" method="POST" action="/submitComment/<%= post._id %>">
        <textarea required name="commentContent" placeholder="Write your comment"></textarea>
        <button type="submit" class="submit-comment-btn">Submit Comment</button>
      </form>
    </div>
  </div>

  <script src="/javascript/openPost.js"></script>
</body>
</html>
